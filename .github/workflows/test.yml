name: Test CoreBoost

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [7.4, 8.0, 8.1, 8.2]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip
        tools: composer
    
    - name: PHP Syntax Check
      run: |
        find . -name "*.php" -exec php -l {} \;
        
    - name: Security Check
      run: |
        # Check for common security issues
        echo "Running security checks..."
        if grep -r "eval(" . --include="*.php"; then
          echo "ERROR: eval() function found"
          exit 1
        fi
        
        # Check for direct unsanitized superglobal usage (allowing filter_input which is secure)
        if grep -rP '\$_(GET|POST|REQUEST|COOKIE)\[' . --include="*.php" | grep -v "filter_input" | grep -v "sanitize" | grep -v "wp_verify_nonce"; then
          echo "ERROR: Unsanitized superglobal usage found"
          echo "Use filter_input() or WordPress sanitization functions"
          exit 1
        fi
        
        echo "✅ Basic security checks passed"

  wordpress-compatibility:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    strategy:
      matrix:
        wordpress-version: ['6.4', '6.3', '6.2', '6.1']
        php-version: [7.4, 8.1]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip, mysql
    
    - name: Setup MySQL
      uses: mirromutth/mysql-action@v1.1
      with:
        mysql version: '8.0'
        mysql database: 'wordpress_test'
        mysql root password: 'root'
    
    - name: Wait for MySQL
      run: |
        echo "Waiting for MySQL to be ready..."
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -u root -proot --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        # Verify connection
        mysql -h 127.0.0.1 -u root -proot -e "SELECT VERSION();" || exit 1
    
    - name: Setup WordPress
      run: |
        # Download WordPress using WP-CLI for reliability
        curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        chmod +x wp-cli.phar
        sudo mv wp-cli.phar /usr/local/bin/wp
        
        # Download and setup WordPress
        wp core download --version=${{ matrix.wordpress-version }} --path=/tmp/wordpress --allow-root
        
        # Create wp-config.php with connection retry
        cd /tmp/wordpress
        wp config create --dbname=wordpress_test --dbuser=root --dbpass=root --dbhost=127.0.0.1 --allow-root --extra-php <<PHP
define('DB_CHARSET', 'utf8mb4');
define('DB_COLLATE', '');
PHP
        
        # Install WordPress
        wp core install --url=http://localhost --title="Test Site" --admin_user=admin --admin_password=admin --admin_email=test@example.com --allow-root
        
    - name: Install CoreBoost Plugin
      run: |
        # Copy plugin files to WordPress
        mkdir -p /tmp/wordpress/wp-content/plugins/coreboost
        cp coreboost.php /tmp/wordpress/wp-content/plugins/coreboost/
        cp readme.txt /tmp/wordpress/wp-content/plugins/coreboost/
        cp -r assets /tmp/wordpress/wp-content/plugins/coreboost/ 2>/dev/null || echo "No assets directory"
        
        # Activate plugin
        cd /tmp/wordpress
        wp plugin activate coreboost --allow-root
        
    - name: Test Plugin Functionality
      run: |
        cd /tmp/wordpress
        
        # Check if plugin is active
        wp plugin list --status=active --allow-root | grep coreboost
        
        # Test plugin options
        wp option get coreboost_options --allow-root || echo "Plugin options not set yet (normal for fresh install)"
        
        # Test basic WordPress functionality
        wp post create --post_title="Test Post" --post_content="Test content" --post_status=publish --allow-root
        
        echo "✅ WordPress compatibility test passed"

  code-quality:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        tools: composer
    
    - name: Install PHP CodeSniffer
      run: |
        composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer global require --dev wp-coding-standards/wpcs:"^3.0" --with-all-dependencies
        
    - name: Configure PHPCS
      run: |
        ~/.composer/vendor/bin/phpcs --config-set installed_paths ~/.composer/vendor/wp-coding-standards/wpcs
        ~/.composer/vendor/bin/phpcs -i
        
    - name: Run WordPress Coding Standards (Relaxed)
      run: |
        # Run with relaxed rules to avoid failing on minor issues
        ~/.composer/vendor/bin/phpcs --standard=WordPress --ignore=*/vendor/*,*/node_modules/* --extensions=php --severity=5 coreboost.php || echo "⚠️ Coding standards warnings found (non-blocking)"
        
    - name: Check File Structure
      run: |
        echo "Checking plugin file structure..."
        
        # Check required files exist
        test -f coreboost.php && echo "✅ Main plugin file exists"
        test -f readme.txt && echo "✅ Readme file exists"
        
        # Check plugin header
        grep -q "Plugin Name:" coreboost.php && echo "✅ Plugin header found"
        grep -q "Version:" coreboost.php && echo "✅ Version found"
        
        echo "✅ File structure check passed"

  plugin-activation-test:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        
    - name: Test Plugin Loading (Minimal)
      run: |
        # Create minimal WordPress environment for testing
        php -r "
        // Define WordPress constants
        define('ABSPATH', '/tmp/');
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', false);
        define('WP_DEBUG_DISPLAY', false);
        
        // Mock WordPress functions that the plugin might use
        if (!function_exists('add_action')) {
            function add_action(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        }
        if (!function_exists('add_filter')) {
            function add_filter(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        }
        if (!function_exists('register_activation_hook')) {
            function register_activation_hook(\$file, \$callback) { return true; }
        }
        if (!function_exists('register_deactivation_hook')) {
            function register_deactivation_hook(\$file, \$callback) { return true; }
        }
        if (!function_exists('plugin_dir_path')) {
            function plugin_dir_path(\$file) { return dirname(\$file) . '/'; }
        }
        if (!function_exists('plugin_dir_url')) {
            function plugin_dir_url(\$file) { return 'http://example.com/wp-content/plugins/' . basename(dirname(\$file)) . '/'; }
        }
        if (!function_exists('plugin_basename')) {
            function plugin_basename(\$file) { return basename(dirname(\$file)) . '/' . basename(\$file); }
        }
        if (!function_exists('get_option')) {
            function get_option(\$option, \$default = false) { return \$default; }
        }
        if (!function_exists('load_plugin_textdomain')) {
            function load_plugin_textdomain(\$domain, \$deprecated = false, \$plugin_rel_path = false) { return true; }
        }
        if (!function_exists('__')) {
            function __(\$text, \$domain = 'default') { return \$text; }
        }
        
        // Try to include the plugin
        try {
            include 'coreboost.php';
            echo '✅ Plugin loaded successfully without fatal errors\n';
        } catch (Exception \$e) {
            echo '❌ Plugin loading failed: ' . \$e->getMessage() . '\n';
            exit(1);
        } catch (Error \$e) {
            echo '❌ Plugin loading failed: ' . \$e->getMessage() . '\n';
            exit(1);
        }
        "
        
    - name: Test Plugin Class Instantiation
      run: |
        php -r "
        // Define minimal WordPress environment
        define('ABSPATH', '/tmp/');
        
        // Mock essential WordPress functions
        function add_action(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        function add_filter(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        function register_activation_hook(\$file, \$callback) { return true; }
        function register_deactivation_hook(\$file, \$callback) { return true; }
        function plugin_dir_path(\$file) { return dirname(\$file) . '/'; }
        function plugin_dir_url(\$file) { return 'http://example.com/wp-content/plugins/' . basename(dirname(\$file)) . '/'; }
        function plugin_basename(\$file) { return basename(dirname(\$file)) . '/' . basename(\$file); }
        function get_option(\$option, \$default = false) { return \$default; }
        function load_plugin_textdomain(\$domain, \$deprecated = false, \$plugin_rel_path = false) { return true; }
        function __(\$text, \$domain = 'default') { return \$text; }
        
        // Include plugin
        include 'coreboost.php';
        
        // Test class instantiation
        try {
            if (class_exists('CoreBoost')) {
                \$plugin = CoreBoost::get_instance();
                echo '✅ Plugin class instantiated successfully\n';
            } else {
                echo '❌ CoreBoost class not found\n';
                exit(1);
            }
        } catch (Exception \$e) {
            echo '❌ Plugin instantiation failed: ' . \$e->getMessage() . '\n';
            exit(1);
        }
        "

  build-test:
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Plugin ZIP
      run: |
        # Create clean plugin directory
        mkdir -p coreboost-build
        
        # Copy plugin files
        cp coreboost.php coreboost-build/
        cp readme.txt coreboost-build/
        cp -r assets coreboost-build/ 2>/dev/null || echo "No assets directory"
        
        # Create ZIP
        cd coreboost-build
        zip -r ../coreboost-test-build.zip .
        cd ..
        
        # Verify ZIP contents
        unzip -l coreboost-test-build.zip
        
        echo "✅ Plugin ZIP created successfully"
        
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: coreboost-test-build
        path: coreboost-test-build.zip
        retention-days: 7
