name: Test CoreBoost

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [7.4, 8.0, 8.1, 8.2]
        wordpress-version: [5.0, 5.5, 6.0, 6.4]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip
        tools: composer, phpunit
    
    - name: Setup WordPress
      run: |
        wget https://wordpress.org/wordpress-${{ matrix.wordpress-version }}.tar.gz
        tar -xzf wordpress-${{ matrix.wordpress-version }}.tar.gz
        mv wordpress /tmp/wordpress
        
    - name: Setup MySQL
      run: |
        sudo systemctl start mysql.service
        mysql -e 'CREATE DATABASE wordpress_test;' -uroot -proot
        
    - name: Configure WordPress
      run: |
        cd /tmp/wordpress
        cp wp-config-sample.php wp-config.php
        sed -i "s/database_name_here/wordpress_test/" wp-config.php
        sed -i "s/username_here/root/" wp-config.php
        sed -i "s/password_here/root/" wp-config.php
        sed -i "s/localhost/127.0.0.1/" wp-config.php
        
    - name: Install CoreBoost
      run: |
        mkdir -p /tmp/wordpress/wp-content/plugins/coreboost
        cp -r * /tmp/wordpress/wp-content/plugins/coreboost/
        
    - name: PHP Syntax Check
      run: |
        find . -name "*.php" -exec php -l {} \;
        
    - name: WordPress Coding Standards
      run: |
        composer global require "squizlabs/php_codesniffer=*"
        composer global require "wp-coding-standards/wpcs=*"
        ~/.composer/vendor/bin/phpcs --config-set installed_paths ~/.composer/vendor/wp-coding-standards/wpcs
        ~/.composer/vendor/bin/phpcs --standard=WordPress coreboost.php
        
    - name: Security Check
      run: |
        # Check for common security issues
        grep -r "eval(" . && exit 1 || echo "No eval() found"
        grep -r "\$_GET\[" . && exit 1 || echo "No direct \$_GET usage found"
        grep -r "\$_POST\[" . && exit 1 || echo "No direct \$_POST usage found"
        echo "Basic security checks passed"

  compatibility-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP 8.1
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        
    - name: Test Plugin Activation
      run: |
        # Simulate WordPress plugin activation
        php -r "
        define('ABSPATH', '/tmp/');
        define('WP_DEBUG', true);
        include 'coreboost.php';
        echo 'Plugin loaded successfully';
        "
        
    - name: Test Default Options
      run: |
        php -r "
        define('ABSPATH', '/tmp/');
        include 'coreboost.php';
        \$plugin = CoreBoost::get_instance();
        echo 'Plugin instantiated successfully';
        "
