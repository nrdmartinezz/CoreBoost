name: Test CoreBoost

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [7.4, 8.0, 8.1, 8.2]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip
        tools: composer
    
    - name: PHP Syntax Check
      run: |
        find . -name "*.php" -exec php -l {} \;
        
    - name: Security Check
      run: |
        # Check for common security issues
        echo "Running security checks..."
        if grep -r "eval(" . --include="*.php"; then
          echo "ERROR: eval() function found"
          exit 1
        fi
        
        # Check for direct unsanitized superglobal usage (allowing filter_input which is secure)
        if grep -rP '\$_(GET|POST|REQUEST|COOKIE)\[' . --include="*.php" | grep -v "filter_input" | grep -v "sanitize" | grep -v "wp_verify_nonce"; then
          echo "ERROR: Unsanitized superglobal usage found"
          echo "Use filter_input() or WordPress sanitization functions"
          exit 1
        fi
        
        echo "✅ Basic security checks passed"

  wordpress-compatibility:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    strategy:
      matrix:
        wordpress-version: ['6.4', '6.3', '6.2', '6.1']
        php-version: [7.4, 8.1]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl, gd, xml, zip, mysql
    
    - name: Setup MySQL
      uses: mirromutth/mysql-action@v1.1
      with:
        mysql version: '8.0'
        mysql database: 'wordpress_test'
        mysql root password: 'root'
    
    - name: Wait for MySQL
      run: |
        echo "Waiting for MySQL to be ready..."
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -u root -proot --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        # Verify connection
        mysql -h 127.0.0.1 -u root -proot -e "SELECT VERSION();" || exit 1
    
    - name: Setup WordPress
      run: |
        # Download WordPress using WP-CLI for reliability
        curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        chmod +x wp-cli.phar
        sudo mv wp-cli.phar /usr/local/bin/wp
        
        # Download and setup WordPress
        wp core download --version=${{ matrix.wordpress-version }} --path=/tmp/wordpress --allow-root
        
        # Create wp-config.php
        cd /tmp/wordpress
        wp config create --dbname=wordpress_test --dbuser=root --dbpass=root --dbhost=127.0.0.1 --allow-root
        
        # Install WordPress
        wp core install --url=http://localhost --title="Test Site" --admin_user=admin --admin_password=admin --admin_email=test@example.com --allow-root
        
    - name: Install CoreBoost Plugin
      run: |
        # Copy plugin files to WordPress
        mkdir -p /tmp/wordpress/wp-content/plugins/coreboost
        cp coreboost.php /tmp/wordpress/wp-content/plugins/coreboost/
        cp readme.txt /tmp/wordpress/wp-content/plugins/coreboost/
        
        # Copy modular includes directory (22 PHP classes)
        cp -r includes /tmp/wordpress/wp-content/plugins/coreboost/
        
        # Copy assets directory
        cp -r assets /tmp/wordpress/wp-content/plugins/coreboost/ 2>/dev/null || echo "No assets directory"
        
        # Verify file structure
        echo "Verifying plugin structure..."
        test -d /tmp/wordpress/wp-content/plugins/coreboost/includes && echo "✅ includes/ directory copied"
        test -d /tmp/wordpress/wp-content/plugins/coreboost/includes/admin && echo "✅ includes/admin/ exists"
        test -d /tmp/wordpress/wp-content/plugins/coreboost/includes/public && echo "✅ includes/public/ exists"
        test -d /tmp/wordpress/wp-content/plugins/coreboost/includes/core && echo "✅ includes/core/ exists"
        
        # Count PHP class files (should be 22)
        CLASS_COUNT=$(find /tmp/wordpress/wp-content/plugins/coreboost/includes -name "*.php" | wc -l)
        echo "Found $CLASS_COUNT PHP class files"
        if [ "$CLASS_COUNT" -lt 20 ]; then
          echo "❌ ERROR: Expected at least 20 class files, found $CLASS_COUNT"
          exit 1
        fi
        
        # Activate plugin
        cd /tmp/wordpress
        wp plugin activate coreboost --allow-root
        
    - name: Test Plugin Functionality
      run: |
        cd /tmp/wordpress
        
        # Check if plugin is active
        wp plugin list --status=active --allow-root | grep coreboost
        
        # Test plugin options
        wp option get coreboost_options --allow-root || echo "Plugin options not set yet (normal for fresh install)"
        
        # Test basic WordPress functionality
        wp post create --post_title="Test Post" --post_content="Test content" --post_status=publish --allow-root
        
        echo "✅ WordPress compatibility test passed"

  code-quality:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        tools: composer
    
    - name: Install PHP CodeSniffer
      run: |
        composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer global require --dev wp-coding-standards/wpcs:"^3.0" --with-all-dependencies
        
    - name: Configure PHPCS
      run: |
        ~/.composer/vendor/bin/phpcs --config-set installed_paths ~/.composer/vendor/wp-coding-standards/wpcs
        ~/.composer/vendor/bin/phpcs -i
        
    - name: Run WordPress Coding Standards (Relaxed)
      run: |
        # Run with relaxed rules to avoid failing on minor issues
        ~/.composer/vendor/bin/phpcs --standard=WordPress --ignore=*/vendor/*,*/node_modules/* --extensions=php --severity=5 coreboost.php || echo "⚠️ Coding standards warnings found (non-blocking)"
        
    - name: Check File Structure
      run: |
        echo "Checking plugin file structure..."
        
        # Check required files exist
        test -f coreboost.php && echo "✅ Main plugin file exists"
        test -f readme.txt && echo "✅ Readme file exists"
        test -f CHANGELOG.md && echo "✅ Changelog exists"
        
        # Check plugin header
        grep -q "Plugin Name:" coreboost.php && echo "✅ Plugin header found"
        grep -q "Version:" coreboost.php && echo "✅ Version found"
        
        # Check modular structure (v2.0.0)
        test -d includes && echo "✅ includes/ directory exists"
        test -d includes/admin && echo "✅ includes/admin/ exists"
        test -d includes/public && echo "✅ includes/public/ exists"
        test -d includes/core && echo "✅ includes/core/ exists"
        
        # Count class files
        CLASS_COUNT=$(find includes -name "class-*.php" | wc -l)
        echo "Found $CLASS_COUNT class files"
        if [ "$CLASS_COUNT" -lt 20 ]; then
          echo "❌ ERROR: Expected at least 20 class files, found $CLASS_COUNT"
          exit 1
        fi
        
        # Verify main classes exist
        test -f includes/class-coreboost.php && echo "✅ Main CoreBoost class exists"
        test -f includes/class-loader.php && echo "✅ Loader class exists"
        test -f includes/class-autoloader.php && echo "✅ Autoloader class exists"
        
        # Verify v2.0.0 GTM classes
        test -f includes/core/class-gtm-detector.php && echo "✅ GTM_Detector class exists (v2.0.0)"
        test -f includes/public/class-gtm-manager.php && echo "✅ GTM_Manager class exists (v2.0.0)"
        test -f includes/admin/class-gtm-settings.php && echo "✅ GTM_Settings class exists (v2.0.0)"
        
        echo "✅ File structure check passed"

  plugin-activation-test:
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
    
    - name: Check for Missing Method Calls
      run: |
        echo "Checking for undefined method calls..."
        
        # Extract all method calls like $this->method_name()
        METHOD_CALLS=$(grep -oP '\$this->\K[a-zA-Z_][a-zA-Z0-9_]*(?=\()' coreboost.php | sort -u)
        
        # Extract all defined methods (public, private, protected)
        DEFINED_METHODS=$(grep -oP '(public|private|protected)\s+function\s+\K[a-zA-Z_][a-zA-Z0-9_]*(?=\()' coreboost.php | sort -u)
        
        echo "Methods called:"
        echo "$METHOD_CALLS"
        echo ""
        echo "Methods defined:"
        echo "$DEFINED_METHODS"
        echo ""
        
        # Check for undefined methods
        MISSING_METHODS=""
        for method in $METHOD_CALLS; do
          if ! echo "$DEFINED_METHODS" | grep -q "^${method}$"; then
            MISSING_METHODS="$MISSING_METHODS\n  - $method()"
          fi
        done
        
        if [ -n "$MISSING_METHODS" ]; then
          echo "❌ ERROR: Methods called but not defined:"
          echo -e "$MISSING_METHODS"
          exit 1
        fi
        
        echo "✅ All called methods are defined"
    
    - name: Check Activation Hook Registration
      run: |
        echo "Checking activation/deactivation hook registration..."
        
        # Check if hooks are registered OUTSIDE the class (correct way)
        if grep -q "register_activation_hook.*__FILE__" coreboost.php; then
          # Check if it's inside a class method (incorrect)
          if grep -B10 "register_activation_hook.*__FILE__" coreboost.php | grep -q "private function\|public function\|protected function"; then
            echo "❌ ERROR: Activation hooks should not be inside class methods"
            echo "They should be registered outside the class using the main plugin file"
            exit 1
          fi
          echo "✅ Activation hooks properly registered outside class"
        else
          echo "✅ No inline activation hooks found (using function wrappers is good)"
        fi
        
        # Verify activation/deactivation functions exist
        if ! grep -q "register_activation_hook" coreboost.php; then
          echo "⚠️ WARNING: No activation hook registered"
        fi
        
        if ! grep -q "register_deactivation_hook" coreboost.php; then
          echo "⚠️ WARNING: No deactivation hook registered"
        fi
        
    - name: Test Plugin Loading (Minimal)
      run: |
        # Create minimal WordPress environment for testing
        php -r "
        // Define WordPress constants
        define('ABSPATH', '/tmp/');
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', false);
        define('WP_DEBUG_DISPLAY', false);
        
        // Mock WordPress functions that the plugin might use
        if (!function_exists('add_action')) {
            function add_action(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        }
        if (!function_exists('add_filter')) {
            function add_filter(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        }
        if (!function_exists('register_activation_hook')) {
            function register_activation_hook(\$file, \$callback) { return true; }
        }
        if (!function_exists('register_deactivation_hook')) {
            function register_deactivation_hook(\$file, \$callback) { return true; }
        }
        if (!function_exists('plugin_dir_path')) {
            function plugin_dir_path(\$file) { return dirname(\$file) . '/'; }
        }
        if (!function_exists('plugin_dir_url')) {
            function plugin_dir_url(\$file) { return 'http://example.com/wp-content/plugins/' . basename(dirname(\$file)) . '/'; }
        }
        if (!function_exists('plugin_basename')) {
            function plugin_basename(\$file) { return basename(dirname(\$file)) . '/' . basename(\$file); }
        }
        if (!function_exists('get_option')) {
            function get_option(\$option, \$default = false) { return \$default; }
        }
        if (!function_exists('load_plugin_textdomain')) {
            function load_plugin_textdomain(\$domain, \$deprecated = false, \$plugin_rel_path = false) { return true; }
        }
        if (!function_exists('__')) {
            function __(\$text, \$domain = 'default') { return \$text; }
        }
        
        // Try to include the plugin
        try {
            include 'coreboost.php';
            echo '✅ Plugin loaded successfully without fatal errors\n';
        } catch (Exception \$e) {
            echo '❌ Plugin loading failed: ' . \$e->getMessage() . '\n';
            exit(1);
        } catch (Error \$e) {
            echo '❌ Plugin loading failed: ' . \$e->getMessage() . '\n';
            exit(1);
        }
        "
        
    - name: Test Plugin Class Instantiation
      run: |
        php -r "
        // Define minimal WordPress environment
        define('ABSPATH', '/tmp/');
        
        // Mock essential WordPress functions
        function add_action(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        function add_filter(\$hook, \$callback, \$priority = 10, \$args = 1) { return true; }
        function apply_filters(\$hook, \$value) { return \$value; }
        function do_action(\$hook) { return true; }
        function register_activation_hook(\$file, \$callback) { return true; }
        function register_deactivation_hook(\$file, \$callback) { return true; }
        function plugin_dir_path(\$file) { return dirname(\$file) . '/'; }
        function plugin_dir_url(\$file) { return 'http://example.com/wp-content/plugins/' . basename(dirname(\$file)) . '/'; }
        function plugin_basename(\$file) { return basename(dirname(\$file)) . '/' . basename(\$file); }
        function get_option(\$option, \$default = false) { return \$default; }
        function update_option(\$option, \$value) { return true; }
        function delete_option(\$option) { return true; }
        function load_plugin_textdomain(\$domain, \$deprecated = false, \$plugin_rel_path = false) { return true; }
        function __(\$text, \$domain = 'default') { return \$text; }
        function _e(\$text, \$domain = 'default') { echo \$text; }
        function esc_html(\$text) { return htmlspecialchars(\$text, ENT_QUOTES, 'UTF-8'); }
        function esc_attr(\$text) { return htmlspecialchars(\$text, ENT_QUOTES, 'UTF-8'); }
        function esc_url(\$url) { return filter_var(\$url, FILTER_SANITIZE_URL); }
        function is_admin() { return false; }
        function wp_doing_ajax() { return false; }
        function wp_unslash(\$value) { return stripslashes(\$value); }
        function sanitize_text_field(\$text) { return trim(strip_tags(\$text)); }
        function sanitize_key(\$key) { return strtolower(trim(\$key)); }
        function current_user_can(\$capability) { return false; }
        function get_transient(\$transient) { return false; }
        function set_transient(\$transient, \$value, \$expire = 0) { return true; }
        function delete_transient(\$transient) { return true; }
        function wp_enqueue_script(\$handle, \$src = '', \$deps = array(), \$ver = false, \$in_footer = false) { return true; }
        function wp_enqueue_style(\$handle, \$src = '', \$deps = array(), \$ver = false, \$media = 'all') { return true; }
        function wp_script_is(\$handle, \$status = 'enqueued') { return false; }
        function wp_style_is(\$handle, \$status = 'enqueued') { return false; }
        function wp_dequeue_script(\$handle) { return true; }
        function wp_dequeue_style(\$handle) { return true; }
        function wp_deregister_script(\$handle) { return true; }
        function wp_deregister_style(\$handle) { return true; }
        function wp_localize_script(\$handle, \$object_name, \$l10n) { return true; }
        function add_menu_page(\$page_title, \$menu_title, \$capability, \$menu_slug, \$function = '', \$icon_url = '', \$position = null) { return true; }
        function add_submenu_page(\$parent_slug, \$page_title, \$menu_title, \$capability, \$menu_slug, \$function = '') { return true; }
        
        // Include plugin
        include 'coreboost.php';
        
        // Test class instantiation
        try {
            if (class_exists('CoreBoost\CoreBoost')) {
                \$plugin = CoreBoost\CoreBoost::get_instance();
                echo '✅ Plugin class instantiated successfully\n';
            } else {
                echo '❌ CoreBoost class not found\n';
                exit(1);
            }
        } catch (Exception \$e) {
            echo '❌ Plugin instantiation failed: ' . \$e->getMessage() . '\n';
            exit(1);
        }
        "

  build-test:
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Plugin ZIP
      run: |
        # Create clean plugin directory
        mkdir -p coreboost-build
        
        # Copy plugin files
        cp coreboost.php coreboost-build/
        cp readme.txt coreboost-build/
        cp README.md coreboost-build/
        cp CHANGELOG.md coreboost-build/
        
        # Copy modular includes (22 PHP classes)
        cp -r includes coreboost-build/
        
        # Copy assets
        cp -r assets coreboost-build/ 2>/dev/null || echo "No assets directory"
        
        # Verify structure before zipping
        echo "Verifying build structure..."
        find coreboost-build -type f -name "*.php" | wc -l
        test -d coreboost-build/includes && echo "✅ includes/ copied"
        
        # Create ZIP
        cd coreboost-build
        zip -r ../coreboost-test-build.zip .
        cd ..
        
        # Verify ZIP contents
        echo "ZIP contents:"
        unzip -l coreboost-test-build.zip
        
        # Count PHP files in ZIP
        PHP_COUNT=$(unzip -l coreboost-test-build.zip | grep "\.php$" | wc -l)
        echo "PHP files in ZIP: $PHP_COUNT"
        if [ "$PHP_COUNT" -lt 23 ]; then
          echo "❌ ERROR: Expected at least 23 PHP files (1 main + 22 classes), found $PHP_COUNT"
          exit 1
        fi
        
        echo "✅ Plugin ZIP created successfully with all classes"
        
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: coreboost-test-build
        path: coreboost-test-build.zip
        retention-days: 7
